Results of a 3D MHD simulation of a sunspot with a photospheric size of about 20 Mm are presented. The simulation has been carried out with the MURaM code, which includes a realistic equation of state with partial ionization and radiative transfer along many ray directions. The largely relaxed state of the sunspot shows a division in a central dark umbral region with bright dots and a penumbra showing bright filaments of about 2 to 3 Mm length with central dark lanes. By a process similar to the formation of umbral dots, the penumbral filaments result from magneto-convection in the form of upflow plumes, which become elongated by the presence of an inclined magnetic field: the upflow is deflected in the outward direction while the magnetic field is weakened and becomes almost horizontal in the upper part of the plume near the level of optical depth unity. A dark lane forms owing to the piling up of matter near the cusp-shaped top of the rising plume that leads to an upward bulging of the surfaces of constant optical depth. The simulated penumbral structure corresponds well to the observationally inferred interlocking-comb structure of the magnetic field with Evershed outflows along dark-laned filaments with nearly horizontal magnetic field and overturning perpendicular (`twisting') motion, which are embedded in a background of stronger and less inclined field. Photospheric spectral lines are formed at the very top and somewhat above the upflow plumes, so that they do not fully sense the strong flow as well as the large field inclination and significant field strength reduction in the upper part of the plume structures.