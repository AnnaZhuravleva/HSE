We present a new implementation of the magnetic Doppler imaging technique, which aims at self-consistent temperature and magnetic mapping of the surface structures in cool active stars. Our magnetic imaging procedure is unique in its capability to model individual spectral features in all four Stokes parameters. We discuss performance and intrinsic limitations of the new magnetic Doppler imaging method. A special emphasis is given to the simultaneous modelling of the magnetically sensitive lines in the optical and infrared regions and to combining information from both atomic and molecular spectral features. These two techniques may, for the first time, give us a tool to study magnetic fields in the starspot interiors.