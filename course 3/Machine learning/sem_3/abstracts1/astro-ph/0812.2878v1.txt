A cloud of gas collapsing under gravity will fragment. We present a new theory for this process, in which layers shocked gas fragment due to their gravitational instability. Our model explains why angular momentum does not inhibit the collapse process. The theory predicts that the fragmentation process produces objects which are significantly smaller than most stars, implying that accretion onto the fragments plays an essential role in determining the initial masses of stars. This prediction is also consistent with the hypothesis that planets can be produced by gravitational collapse.