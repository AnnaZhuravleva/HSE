The decoy state protocol has been considered to be one of the most important methods to protect the security of quantum key distribution (QKD) with a weak coherent source. Here we test two experimental approaches to generating the decoy states with different intensities: modulation of the pump current of a semiconductor laser diode, and external modulation by an optical intensity modulator. The former approach shows a side-channel in the time domain that allows an attacker to distinguish the signal from the decoy, breaking a basic assumption in the protocol. We model a photon-number-splitting attack based on our experimental data, and show that it compromises the system's security. We then modify the system's security proof to tolerate a general imperfect source with distinguishable signal and decoy states. Our proof produces a tightened, lower secure key rate. To improve this key rate, we propose to calibrate the transmittance of the receiver (Bob's) unit. We apply our proof to three QKD systems and estimate their secure key rates.